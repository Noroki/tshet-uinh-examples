/* 推導新塘話
 *
 * @author Noroki
 *
 * @specialThanks Ayaka
 */

/** @type { 音韻地位['屬於'] } */
const is = (...x) => 音韻地位.屬於(...x);
/** @type { 音韻地位['判斷'] } */
const when = (...x) => 音韻地位.判斷(...x);

// * 選項
if (!音韻地位)
  return [
    ['標調方式', [1, '調值', '調號']],
    ['變調調值', [1, '本調', '前字變調', '後字變調']],
  ];

if (is`云母 通攝 舒聲`) 音韻地位 = 音韻地位.調整('匣母', ['匣母三等']);

function 聲母規則() {
  return when([
    ['幫滂並母 C類', 'f'], // ** C類
    ['幫母 或 並母 仄聲', 'b'],
    ['滂母 或 並母 平聲', 'p'],
    ['明母', 'm'],

    ['端母 或 定母 仄聲', 'd'],
    ['透母 或 定母 平聲', 't'],
    ['泥孃母', 'l'], // * n - l
    ['來母', 'l'],

    ['精莊知章母 或 從崇俟邪澄母 仄聲', 'z'], // 精莊組濁音塞擦音多於擦音（下同）
    ['清初徹昌母 或 從崇俟邪澄母 平聲', 'c'],
    ['心生常書船母', 's'], // 章組濁音擦音多於塞擦音

    ['見母 或 羣母 仄聲', 'g'],
    ['羣母 平聲', 'k'],
    ['疑母', 'ng'], // 細音為 j，詳後 // ** ng > j: 拼展脣或後元音時為 w，詳後

    ['溪曉母', 'h'], // 溪母多數擦化；三四等拼 a 元音部分韻母時為 j/w，詳後
    ['匣母', [
      ['合口 或 (遇攝 一等)', 'j'], // 拼展脣或後元音時為 w，詳後
      ['', 'h'],
    ]],
    ['影云以日母', [
      ['三四等', 'j'], // 拼展脣或後元音時為 w，詳後
      ['', ''],
    ]],
  ], '無聲母規則');
}

function 韻母規則() {
  return when([
    ['通攝', 'ung'],

    ['止攝', [
      ['脣音', 'ei'],
      ['開口 (端組 或 孃來母 或 見溪羣曉母)', 'ei'],
      ['開口 舌音', 'ei'], // * i - ei
      ['開口 精莊章組', 'ei'], // * i - ei
      ['開口 日母', 'i'], // *? i - ei
      ['開口', 'i'],
      // ['合口 舌齒音', 'eoi'], // * eoi - ui
      ['合口 舌音', 'eoi'], // *? eoi - ui
      ['合口 齒音', 'ui'], // * eoi - ui
      ['合口 牙喉音', 'ai'],
    ]],

    ['遇攝', [
      ['三四等', [
        ['幫滂並母', 'u'],
        ['明母', 'ou'],
        ['莊組', 'o'],
        ['端精組 或 孃來母 或 見溪羣曉母', 'eoi'],
        ['', 'yu'],
      ]],
      ['一等', [
        ['脣音 或 舌齒音', 'ou'],
        ['疑母', 'm'], // * ng - m
        ['牙喉音', 'u'],
      ]],
    ]],

    ['蟹攝', [
      ['廢韻 平上聲 章組', 'ui'], // 參照「茝」coi2 // * ooi?
      ['合口 銳音', 'ui'], // 含以母 // * eoi - ui, ooi? 
      ['三四等', 'ai'],
      ['二等 或 泰韻 開口 (端組 或 來母)', 'aai'],
      ['一等', [
        ['開口 或 疑母', 'ui'], // * oi - ui, ooi?
        ['', 'ui'],
      ]],
    ]],

    ['臻攝', [
      ['三四等', [
        // ['合口 舌齒音', 'eon'], // * eon - ang
        ['合口 莊章組', 'ung'], // * eon - ung
        ['合口 精組', 'yun'], // * eon - yun
        ['', 'ang'], // * an - ang
      ]],
      ['一等', [
        ['脣音', 'uung'], // * un - uung
        ['合口 (端組 或 來母)', 'ang'], // * eon - ang
        ['合口 精組', 'yun'],
        ['', 'ang'], // * an - ang
      ]],
    ]],

    ['山攝', [
      ['脣音 C類', 'aang'], // * aan - aang // ** C類
      ['二等', 'aang'], // * aan - aang
      ['三四等', [
        ['開口 或 脣音', 'in'],
        ['合口', 'yun'],
      ]],
      ['一等', [
        ['開口 見母', 'uung'], // * on > un - uung
        ['開口 舌齒音', 'aang'], // * aan - aang
        ['開口 牙喉音', 'yun'], // on > un - yun
        ['合口 舌齒音', 'yun'],
        ['合口 牙喉音 或 脣音', 'uung'], // * un - uung
      ]],
    ]],

    ['效攝', [
      ['三四等', 'iu'],
      ['二等', 'aau'],
      ['一等', 'ou'],
    ]],

    ['果假攝', [
      ['三四等', [ 
        ['脣音 C類', 'o'], /// 「縛」 // ** C類
        ['見影組 C類', 'oe'], // * 「茄」 // ** C類
        ['開口 或 脣音', 'iaa'], // * e - iaa
        ['合口', 'oe'],
      ]],
      ['二等', 'aa'],
      // ['一等', 'o'], // * o - oe
      ['一等', [ 
        ['合口 舌音', 'oe'], // *? o - oe
        ['', 'o'], // *
      ]],
    ]],

    ['宕江攝', [
      ['三四等', [
        ['脣音 C類', 'ong'], // ** C類
        ['開口 莊組 或 合口', 'ong'],
        ['', 'oeng'],
      ]],
      ['二等 舌齒音', 'oeng'],
      ['一二等', 'ong'],
    ]],

    ['梗曾攝', [
      ['一二等 或 梗攝 莊組', [ // 文 ang、白 aang，兩者勢均，推導音依文讀
        ['庚韻 二等 (來母 或 端組)', 'aang'], // 唯來母「冷」向無 lang 音例，故例外，端組亦從之
        ['', 'ang'],
      ]],
      ['三四等', 'ang'], // * ing - ang
    ]],

    ['流攝', [
      ['四等 端組 或 幽韻 幫滂並母', 'iu'], // 「丟」「彪」「淲」
      ['', 'au'],
    ]],

    ['深攝', 'am'], // -m 拼脣音時為 -n，詳後，下同

    ['咸攝', [
      ['脣音 C類', 'aang'], // * aam - aang // ** C類
      ['二等', 'aang'], // * aam - aang
      ['三四等', 'in'], // * im - in
      ['一等 脣舌齒音', 'aang'], // 脣音僅僻字，如「姏」maan4 // * aam - aang
      ['一等 牙喉音', 'om'], // -om 併入 -am，但影響陰入分化，詳後
    ]],
  ], '無韻母規則');
}

function 聲調規則() {
  return when([
    ['清音', [
      ['平聲', '1'],
      ['上聲', '2'],
      // ['去入聲', '3'], // 中入於短元音為 1（陰入），詳後
      ['去聲', '3'], // * 
      ['入聲', '8'], // * 中入於短元音為 7（陰入），詳後
    ]],
    ['濁音', [
      ['平聲', '4'],
      ['上聲 次濁', '5'],
      // ['上聲 全濁 或 去入聲', '6'], 
      ['上聲 全濁 或 去聲', '6'], // * 
      ['入聲', '9'], // * 
    ]]
  ], '無聲調規則');
}

// * 前字變調
const 前字變調 = {
    1: '⁵³', // * 前字變調
    2: '²²', // * 前字變調
    3: '³³',
    4: '¹¹',
    5: '²²', // * 前字變調
    6: '²²',
    7: '⁵',
    8: '³',
    9: '³',
};

// * 後字變調
const 後字變調 = {
    1: '²⁴',
    2: '³⁵',
    3: '³³',
    4: '⁵⁵', // * 後字變調
    5: '³³',
    6: '²²',
    7: '⁵',
    8: '³',
    9: '³',
};

// * 前字變調調號
const 前字調號 = {
    1: '1*', // * 前字變調
    2: '2*', // * 前字變調
    3: '3',
    4: '4',
    5: '5*', // * 前字變調
    6: '6',
    7: '7',
    8: '8',
    9: '9',
};

// * 後字變調調號
const 後字調號 = {
    1: '1',
    2: '2', 
    3: '3',
    4: '4*', // * 前字變調
    5: '5', 
    6: '6',
    7: '7',
    8: '8',
    9: '9',
};

// * 調值
const 調值 = {
  1: '²⁴',
  2: '³⁵',
  3: '³³',
  4: '¹¹',
  5: '³³',
  6: '²²',
  7: '⁵',
  8: '³',
  9: '³',
};


function is短元音(韻母) {
  if (['am', 'an', 'ang', 'eon', 'ing', 'ung'].includes(韻母)) return true;
  // if (['aam', 'aan', 'im', 'in', 'om', 'on', 'ong', 'oeng', 'un', 'yun'].includes(韻母)) return false; 
  if (['aam', 'aan', 'aang', 'im', 'in', 'om', 'on', 'ong', 'oeng', 'un', 'yun'].includes(韻母)) return false; // * 新增 aang
  throw new Error('無長短元音規則：' + 韻母);
}

let 聲母 = 聲母規則();
let 韻母 = 韻母規則();
let 聲調 = 聲調規則();

// ng 拼細音時為 j
const is細音 = ['eo', 'i', 'oe', 'u', 'yu'].some(x => 韻母.startsWith(x));
if (聲母 === 'ng' && is細音) 聲母 = 'j';

// 三四等清調 h 拼 a 元音部分韻母時為 j/w /// * 清音h: 溪曉母。au 流攝、an 臻攝、am 深攝。
// if (聲母 === 'h' && ['au', 'an', 'am'].includes(韻母) && is`清音 三四等 非 (臻攝 開口 入聲) 非 (臻攝 合口 舒聲)`) { // * an - ang 影響條件，需要修正
if (聲母 === 'h' && ['au', 'an', 'am'].some(x => 韻母.startsWith(x)) && is`流臻深攝` && is`清音 三四等 非 (臻攝 開口 入聲) 非 (臻攝 合口 舒聲)`) { // * 修正
  聲母 = 'j';
}

// 陰入分化
// if (is`入聲` && 聲調 === '3' && is短元音(韻母)) 聲調 = '1'; // * 
if (is`入聲` && 聲調 === '8' && is短元音(韻母)) 聲調 = '7'; // * 

// 合口
if (is`合口 或 模韻` && !['eo', 'oe', 'yu'].some(x => 韻母.startsWith(x))) {
  if ((聲母 === 'g' || 聲母 === 'k') && !韻母.startsWith('u')) 聲母 += 'w';
  else if (聲母 === 'h' && !韻母.startsWith('i')) 聲母 = 'f';
  // else if (聲母 === 'j' || 聲母 === '') 聲母 = 'w'; 
  else if ((聲母 === 'j' && !is`蟹攝 日以母`) || 聲母 === '') 聲母 = 'w'; // * oo: 疑母，匣影云、以日母合口非 eo, oe, yu: j > w
}

// * ng - 0 
if (聲母 === 'ng') 聲母 = '';

// * ooi = ui // ** TODO

// * gw, kw - g, k
if (['gw', 'kw'].includes(聲母) && 韻母.startsWith('o')) 聲母 = 聲母.slice(0, -1);

// -om 併入 -am
if (韻母 === 'om') 韻母 = 'am';

// m 韻尾在聲母為脣音時為 n
if (is`脣音` && 韻母.endsWith('m')) 韻母 = 韻母.slice(0, -1) + 'n';

if (is`入聲`) {
  if (韻母.endsWith('m')) 韻母 = 韻母.slice(0, -1) + 'p';
  else if (韻母.endsWith('n')) 韻母 = 韻母.slice(0, -1) + 't';
  else if (韻母.endsWith('ng')) 韻母 = 韻母.slice(0, -2) + 'k';
}

// return 聲母 + 韻母 + 聲調; // * 
if (選項.標調方式 === '調值')
    if (選項.變調調值 === '前字變調') return 聲母 + 韻母 + 前字變調[聲調];
    else if (選項.變調調值 === '後字變調') return 聲母 + 韻母 + 後字變調[聲調];
    else return 聲母 + 韻母 + 調值[聲調];
else 
    if (選項.變調調值 === '前字變調') return 聲母 + 韻母 + 前字調號[聲調];
    else if (選項.變調調值 === '後字變調') return 聲母 + 韻母 + 後字調號[聲調];
    else return 聲母 + 韻母 + 聲調; 

